<!-- htmlmin:ignore -->
{% if compare is defined and compare == true %}
    {% set rollingPeriods = [] %}
{% else %}
    {% set compare = false %}
{% endif %}
<div class="row">
    <div class="col">
        {{adminltetags.useTag('fields',
            [
                'component'                             : component,
                'componentName'                         : componentName,
                'componentId'                           : componentId,
                'sectionId'                             : sectionId,
                'fieldId'                               : 'rolling_period',
                'fieldLabel'                            : 'Rolling Period',
                'fieldType'                             : 'select2',
                'fieldHelp'                             : true,
                'fieldAdditionalClass'                  : 'mb-0',
                'fieldHelpTooltipContent'               : "Scheme rolling period",
                'fieldRequired'                         : true,
                'fieldBazScan'                          : true,
                'fieldBazPostOnCreate'                  : true,
                'fieldBazPostOnUpdate'                  : true,
                'fieldDataSelect2Options'               : rollingPeriods,
                'fieldDataSelect2OptionsKey'            : 'id',
                'fieldDataSelect2OptionsValue'          : 'name',
                'fieldDataSelect2OptionsArray'          : true,
                'fieldDataSelect2OptionsSelected'       : ''
            ]
        )}}
    </div>
    <div class="col">
        {{adminltetags.useTag('fields',
            [
                'component'                      : component,
                'componentName'                  : componentName,
                'componentId'                    : componentId,
                'sectionId'                      : sectionId,
                'fieldId'                        : 'start_date',
                'fieldLabel'                     : 'Select Start Date',
                'fieldType'                      : 'flatpickr',
                'fieldHelp'                      : true,
                'fieldHelpTooltipContent'        : 'Select Start Date',
                'fieldRequired'                  : true,
                'fieldBazScan'                   : true,
                'fieldBazPostOnCreate'           : false,
                'fieldBazPostOnUpdate'           : true,
                'fieldValue'                     : ''
            ]
        )}}
    </div>
</div>
<hr>
<div class="row" id="rr-chart-intro">
    <div class="col text-center">
        <span>Select rolling period and start date to generate chart</span>
    </div>
</div>
<div class="row" id="rr-chart" hidden>
    <div class="col">
        <div id="rrChart"></div>
    </div>
</div>
<div class="row text-center" id="rr-loader" hidden>
    <div class="col">
        <i class="fa fa-cog fa-spin"></i> Loading rolling returns chart and table...
    </div>
</div>
<hr>
{% set statisticsHeaders = [] %}
{% set statisticsHtml =
    '<div class="row">' ~
    '    <div class="col">' ~
    '        <table id="' ~ componentId ~ '-' ~ sectionId ~ '-statistics-table" class="table table-sm table-hover responsive nowrap table-bordered mb-0" width="100%" cellspacing="0">' ~
    '            <thead>' ~
    '                <tr>' %}
{% if compare is defined and compare == true %}
    {% set statisticsHtml = statisticsHtml ~
    '                    <th class="text-uppercase text-center"></th>' %}
    {% set statisticsHeaders = array_merge(statisticsHeaders, ['Scheme']) %}
{% endif %}
    {% set statisticsHtml = statisticsHtml ~
    '                    <th class="text-uppercase text-center" colspan="4">Return Statistics (%)</th>' ~
    '                    <th class="text-uppercase text-center" colspan="7">Return distribution (% of times)</th>' ~
    '                </tr>' ~
    '                <tr>'
%}
{% set statisticsHeaders = array_merge(statisticsHeaders,
    ['average',
    'median',
    'maximum',
    'minimum',
    'negative',
    '0-8%',
    '8-10%',
    '10-12%',
    '12-15%',
    '15-20%',
    '> 20%'])
%}
{% for statistic in statisticsHeaders %}
    {% set statisticsHtml = statisticsHtml ~ '<th class="text-uppercase">' ~ statistic ~ '</th>' %}
{% endfor %}
{% set statisticsHtml = statisticsHtml ~
    '                </tr>' ~
    '            </thead>' ~
    '            <tbody>' ~
    '            </tbody>' ~
    '        </table>' ~
    '    </div>' ~
    '</div>'
%}
<div class="row" id="statistics-div">
    <div class="col">
        {{adminltetags.useTag('fields',
            [
                'component'                      : component,
                'componentName'                  : componentName,
                'componentId'                    : componentId,
                'sectionId'                      : sectionId,
                'fieldId'                        : 'statistics',
                'fieldLabel'                     : 'Return Statistics & Distribution',
                'fieldType'                      : 'html',
                'fieldAdditionalClass'           : 'mb-0',
                'fieldHelp'                      : true,
                'fieldHelpTooltipContent'        : 'Return Statistics & Distribution',
                'fieldRequired'                  : false,
                'fieldBazScan'                   : false,
                'fieldHtmlContent'               : statisticsHtml
            ]
        )}}
    </div>
</div>
<script>
/*global paginatedPNotify BazProgress BazContentFields BazHelpers BazContentLoader Pace BazCore dataCollection echarts dayjs */
var dataCollectionComponent, dataCollectionSection, dataCollectionSectionForm;
if (!window['dataCollection']) {
    window['dataCollection'] = { };
}
if (!window['dataCollection']['{{componentId}}']) {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'] = { };
} else {
    dataCollectionComponent =
        window['dataCollection']['{{componentId}}'];
}
if (!dataCollectionComponent['{{componentId}}-{{sectionId}}']) {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'] = { };
} else {
    dataCollectionSection =
        dataCollectionComponent['{{componentId}}-{{sectionId}}'];
}
if (!dataCollectionSection['{{componentId}}-{{sectionId}}-form']) {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'] = { };
} else {
    dataCollectionSectionForm =
        dataCollectionSection['{{componentId}}-{{sectionId}}-form'];
}

if (!dataCollectionSectionForm['vars']) {
    dataCollectionSectionForm['vars'] = { };
}

dataCollectionSectionForm['vars']['compare'] = '{{compare}}';
dataCollectionSectionForm['vars']['rr_period'] = null;
dataCollectionSectionForm['vars']['rr_start_date'] = '';
dataCollectionSectionForm['vars']['rrChart'] = { };
dataCollectionSectionForm['vars']['rrStatistics'] = { };
dataCollectionSectionForm['vars']['rrDistributions'] = { };
dataCollectionSectionForm['vars']['rrChunks'] = { };

if (!dataCollectionSectionForm['funcs']) {
    dataCollectionSectionForm['funcs'] = { };
}

dataCollectionSectionForm['funcs']['initRRChart'] = function() {
    if (Object.keys(dataCollectionSectionForm['vars']['rrChart']).length === 0) {
        dataCollectionSectionForm['vars']['rrChart'] = echarts.init(document.getElementById('rrChart'), 'macarons');
    }

    if (dataCollectionSectionForm['vars']['compare'] == true) {
        dataCollectionSectionForm['vars']['rrChartOptions'] = {
            title: {
                text: 'Rolling Return Comparison (%)',
                left: 'left'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                  type: 'cross'
                }
            },
            legend: {
                top: 50,
                center: 'center'
            },
            grid: {
                top: 80,
            },
            xAxis: {
                name: 'PERIOD',
                nameLocation: 'middle',
                nameTextStyle: {
                    lineHeight: 50
                },
                data: []
            },
            yAxis: {
                name: 'PERCENT',
                nameRotate: 90,
                nameLocation: "middle",
                nameTextStyle: {
                    lineHeight: 60,
                }
            },
            dataZoom: [
                {
                    type: 'inside'
                }
            ],
            series: []
        }
    } else {
        dataCollectionSectionForm['vars']['rrChartOptions'] = {
            title: {
                text: 'Rolling Returns for ' + dataCollectionSectionForm['vars']['scheme']['name'],
                left: 'left'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                  type: 'cross'
                }
            },
            legend: {
                top: 50,
                center: 'center'
            },
            grid: {
                top: 80,
            },
            xAxis: {
                name: 'PERIOD',
                nameLocation: 'middle',
                nameTextStyle: {
                    lineHeight: 50
                },
                data: []
            },
            yAxis: {
                name: 'PERCENT',
                nameRotate: 90,
                nameLocation: "middle",
                nameTextStyle: {
                    lineHeight: 60,
                }
            },
            dataZoom: [
                {
                    type: 'inside'
                }
            ],
            series: [
                {
                    name: 'CAGR',
                    type: 'line',
                    data: [],
                }
            ]
        }
    }

    dataCollectionSectionForm['vars']['rrChart'].off('rendered');
    dataCollectionSectionForm['vars']['rrChart'].on('rendered', function() {
        if (dataCollectionSectionForm['vars'] &&
            dataCollectionSectionForm['vars']['rrChart']
        ) {
            if ($('#rr-chart').width() > 0) {
                dataCollectionSectionForm['vars']['rrChart'].resize({
                    width : $('#rr-chart').width(),
                    height: 400
                });
            }
        }
    });
}

setTimeout(function(){
    $(document).ready(function() {
        // if (dataCollectionSectionForm['vars']['compare'] == false) {
            dataCollectionSectionForm['funcs']['initRRChart']();
        // }
    });
}, 1000);

if (dataCollectionSectionForm['vars']['compare'] == false) {//Need this condition else compare will not work.
    dataCollectionSection =
        $.extend(dataCollectionSection, {
            '{{componentId}}-{{sectionId}}-date_range'                          : {
                dateFormat          : "Y-m-d",
                altFormat           : "d-m-Y",
                allowInput          : true,
                static              : true,
                mode                : 'range',
                minDate             : "2000-01-01",
                maxDate             : "today",
                onChange: function(selectedDates, dateStr, instance) {
                    if (dateStr.includes('to')) {
                        dataCollectionSectionForm['funcs']['getSchemeNavChunks']('range', dateStr);
                        dataCollectionSectionForm['vars']['rangeActive'] = true;
                        dataCollectionSectionForm['vars']['range'] = dateStr;
                    }
                },
                afterInit: function() {

                    if (dataCollectionSectionForm['vars']['scheme']['custom']) {
                        dataCollectionSection['{{componentId}}-{{sectionId}}-date_range']['flatpickr'].config.minDate = dataCollectionSectionForm['vars']['customNavStartDate'];
                        dataCollectionSection['{{componentId}}-{{sectionId}}-date_range']['flatpickr'].config.maxDate = dataCollectionSectionForm['vars']['customNavEndDate'];
                    } else {
                        dataCollectionSection['{{componentId}}-{{sectionId}}-date_range']['flatpickr'].config.minDate = dataCollectionSectionForm['vars']['scheme']['start_date'];
                        dataCollectionSection['{{componentId}}-{{sectionId}}-date_range']['flatpickr'].config.maxDate = dataCollectionSectionForm['vars']['scheme']['navs_last_updated'];
                    }
                }
            },
            '{{componentId}}-{{sectionId}}-navs_start_date'                     : {
                afterInit: function() {
                    $('#{{componentId}}-{{sectionId}}-import').off();
                    $('#{{componentId}}-{{sectionId}}-import').click(function(e) {
                        e.preventDefault();

                        var thisButton = $(this);
                        $(thisButton).addClass('disabled');
                        $(thisButton).children('i').attr('hidden', false);

                        $('#timeline-buttons').attr('hidden', true);
                        $('#datatype-buttons').attr('hidden', true);
                        $('#timeline-import').attr('hidden', false);
                        $('#timeline-chart').attr('hidden', true);
                        $('#navs-table').attr('hidden', true);

                        var postData = { };
                        postData[$('#security-token').attr('name')] = $('#security-token').val();
                        postData['get_all_navs'] = true;
                        postData['scheme_id'] = dataCollectionSectionForm['vars']['scheme']['id'];

                        $.post('{{links.url("mf/tools/extractdata/getAllNavData")}}', postData, function(response) {
                            $(thisButton).removeClass('disabled');
                            $(thisButton).children('i').attr('hidden', true);

                            $('#timeline-buttons').attr('hidden', false);
                            $('#datatype-buttons').attr('hidden', false);
                            $('#timeline-import').attr('hidden', true);
                            $('#timeline-chart').attr('hidden', false);
                            $('#navs-table').attr('hidden', false);

                            if (response.responseCode == 0) {
                                paginatedPNotify('success', response.responseMessage);

                                dataCollectionSectionForm['funcs']['browse']($(thisButton).attr('href'));
                            } else {
                                paginatedPNotify('error', response.responseMessage);
                            }

                            if (response.tokenKey && response.token) {
                                $("#security-token").attr("name", response.tokenKey);
                                $("#security-token").val(response.token);
                            }
                        }, 'json');
                    });
                }
            },
            '{{componentId}}-{{sectionId}}-navs_end_date'                       : { },
            '{{componentId}}-{{sectionId}}-rolling_period'                      : {
                placeholder : 'SELECT ROLLING PERIOD',
                afterInit : function() {
                    dataCollectionSectionForm['vars']['rr_period'] = $('#{{componentId}}-{{sectionId}}-rolling_period').val();

                    $('#{{componentId}}-{{sectionId}}-rolling_period').on('select2:select', function(e) {
                        dataCollectionSectionForm['vars']['rr_period'] = e.params.data.id;

                        if (dataCollectionSectionForm['vars']['rr_start_date'] !== '') {
                            dataCollectionSectionForm['funcs']['getSchemeRollingReturns']();
                        }
                    });
                }
            },
            '{{componentId}}-{{sectionId}}-start_date'                          : {
                dateFormat          : "Y-m-d",
                altFormat           : "d-m-Y",
                allowInput          : true,
                static              : true,
                minDate             : dataCollectionSectionForm['vars']['scheme']['start_date'],
                maxDate             : "today",
                onChange: function(selectedDates, dateStr, instance) {
                    if (dateStr !== '') {
                        dataCollectionSectionForm['vars']['rr_start_date'] = dateStr;

                        if (dataCollectionSectionForm['vars']['rr_period'] && dataCollectionSectionForm['vars']['rr_period'] != '0') {
                            dataCollectionSectionForm['funcs']['getSchemeRollingReturns']();
                        }
                    }
                },
                afterInit : function() {
                    dataCollectionSection['{{componentId}}-{{sectionId}}-start_date']['flatpickr']['config']['maxDate'] =
                        dayjs(dataCollectionSectionForm['vars']['scheme']['navs_last_updated']).subtract(1, 'year').format('YYYY-MM-DD');

                    dataCollectionSection['{{componentId}}-{{sectionId}}-start_date']['flatpickr'].setDate(dataCollectionSectionForm['vars']['scheme']['start_date']);
                    dataCollectionSectionForm['vars']['rr_start_date'] = dataCollectionSectionForm['vars']['scheme']['start_date'];
                }
            },
            '{{componentId}}-{{sectionId}}-form'                                : {
                ignore      : ':submit, :reset, :image, :hidden, .ignore, .cr-slider',
                rules: {
                },
                messages: {
                }
            },
            '{{componentId}}-{{sectionId}}-custom_source'                       : {
                placeholder: 'SELECT CUSTOM NAVS SOURCE',
                afterInit : function() {
                    $('#{{componentId}}-{{sectionId}}-custom_source').on('select2:select', function() {
                        processCustomSource();
                    });

                    function processCustomSource() {
                        dataCollectionSectionForm['vars']['source'] = $('#{{componentId}}-{{sectionId}}-custom_source').select2('data')[0].id;

                        $('.sources').attr('hidden', true);
                        $('#{{componentId}}-{{sectionId}}-' + dataCollectionSectionForm['vars']['source']).attr('hidden', false);

                        $('#{{componentId}}-{{sectionId}}-number_of_days').val('');
                        $('#{{componentId}}-{{sectionId}}-total_percent').val('');
                        $('#{{componentId}}-{{sectionId}}-pattern').val(0).trigger('change');
                    }

                    processCustomSource();
                }
            },
            '{{componentId}}-{{sectionId}}-pattern'                             : {
                placeholder: 'SELECT PATTERN',
                afterInit : function() {
                    $('#{{componentId}}-{{sectionId}}-pattern').on('select2:select', function() {
                        dataCollectionSectionForm['vars']['pattern_id'] = $('#{{componentId}}-{{sectionId}}-pattern').select2('data')[0].id;
                    });
                }
            },
            '{{componentId}}-{{sectionId}}-fixed_linear_number_of_days'         : { },
            '{{componentId}}-{{sectionId}}-fixed_random_number_of_days'         : { },
            '{{componentId}}-{{sectionId}}-fixed_linear_total_percent'          : { },
            '{{componentId}}-{{sectionId}}-fixed_random_total_percent'          : { },
            '{{componentId}}-{{sectionId}}-custom'                              : {
                afterInit: function() {
                    $('#{{componentId}}-{{sectionId}}-generate-custom').off();
                    $('#{{componentId}}-{{sectionId}}-generate-custom').click(function(e) {
                        e.preventDefault();

                        dataCollectionSectionForm['vars']['custom'] = [];
                        dataCollectionSectionForm['vars']['custom_index'] = [];

                        if ($('#{{componentId}}-{{sectionId}}-custom').val() !== '') {
                            var customs = $('#{{componentId}}-{{sectionId}}-custom').val().split(',');

                            $.each(customs, function(index, custom) {
                                dataCollectionSectionForm['vars']['custom_index'].push(index);
                                dataCollectionSectionForm['vars']['custom'].push(custom.trim());
                            });
                        }

                        dataCollectionSectionForm['funcs']['generateCustomNav']();
                    });

                    $('#{{componentId}}-{{sectionId}}-generate-custom-navs').off();
                    $('#{{componentId}}-{{sectionId}}-generate-custom-navs').click(function(e) {
                        e.preventDefault();

                        if ($('#{{componentId}}-{{sectionId}}-custom').val() === '') {
                            paginatedPNotify('error', {text : 'Please generate navs (%) using the navs (%) generator or enter navs (%) separated by comma'});

                            return;
                        }

                        dataCollectionSectionForm['funcs']['updateSchemeCustomNavs']();
                    });
                }
            },
        });
}

dataCollectionSectionForm['funcs']['getSchemeRollingReturns'] = function(schemeId = null) {
    $('#rr-chart-intro').attr('hidden', true);
    $('#rr-chart').attr('hidden', true);
    $('#rr-loader').attr('hidden', false);

    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    if (schemeId) {
        postData['scheme_id'] = schemeId;
    } else {
        postData['scheme_id'] = dataCollectionSectionForm['vars']['scheme']['id'];
    }
    postData['rr_period'] = dataCollectionSectionForm['vars']['rr_period'];
    postData['start_date'] = dataCollectionSectionForm['vars']['rr_start_date'];

    if (dataCollectionSectionForm['vars']['compare'] == true) {
        postData['compare_start_date'] = dataCollectionSectionForm['vars']['compareSchemesParams']['start_date'];
    }

    if (dataCollectionSectionForm['vars']['custom']) {
        postData['customRollingReturns'] = true;
    }

    if (dataCollectionSectionForm['vars']['schemetimeline'] !== '') {
        postData['timeline'] = dataCollectionSectionForm['vars']['schemetimeline'];
    }

    $.post('{{links.url("mf/schemes/getSchemeRollingReturns")}}', postData, function(response) {
        $('#rr-loader').attr('hidden', true);

        if (response.responseCode == 0 && response.responseData.rrData) {
            dataCollectionSectionForm['funcs']['processResponseData'](postData, response);

            dataCollectionSectionForm['funcs']['processRRChart']();
        } else {
            paginatedPNotify('error', response.responseMessage);
        }

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['processResponseData'] = function(postData, response) {
    dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']] = { };
    dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']]['cagrs'] = [];
    dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']]['periods'] = [];

    for (var data in response.responseData.rrData) {
        dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']]['cagrs']
            .push(response.responseData.rrData[data]['cagr']);
        dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']]['periods']
            .push(response.responseData.rrData[data]['from'] + ' to ' + response.responseData.rrData[data]['to']);
    }

    dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']]['rrStatistics'] = response.responseData.statistics;
    dataCollectionSectionForm['vars']['rrChunks'][postData['scheme_id']]['rrDistributions'] = response.responseData.distribution;
}

dataCollectionSectionForm['funcs']['processRRChart'] = function() {
    if (dataCollectionSectionForm['vars']['compare'] == true &&
        Object.keys(dataCollectionSectionForm['vars']['rrChunks']).length !== Object.keys(dataCollectionSectionForm['vars']['compareSchemes']).length
    ) {
        return;
    }

    dataCollectionSectionForm['vars']['rrChartOptions']['series'] = [];

    var counter = 0;

    $.each(dataCollectionSectionForm['vars']['rrChunks'], function(schemeId, rrData) {
        dataCollectionSectionForm['vars']['rrChartOptions']['series'][counter] = { };
        dataCollectionSectionForm['vars']['rrChartOptions']['series'][counter]['type'] = 'line';

        if (dataCollectionSectionForm['vars']['compare'] == true) {
            dataCollectionSectionForm['vars']['rrChartOptions']['series'][counter]['name'] = dataCollectionSectionForm['vars']['compareSchemes'][schemeId]['name'];
        } else {
            dataCollectionSectionForm['vars']['rrChartOptions']['series'][counter]['name'] = dataCollectionSectionForm['vars']['scheme']['name'];
        }
        dataCollectionSectionForm['vars']['rrChartOptions']['series'][counter]['data'] = dataCollectionSectionForm['vars']['rrChunks'][schemeId]['cagrs'];

        if (dataCollectionSectionForm['vars']['compare'] == true) {
            dataCollectionSectionForm['vars']['scheme'] = dataCollectionSectionForm['vars']['compareSchemes'][schemeId];
        }

        dataCollectionSectionForm['vars']['rrChartOptions']['xAxis']['data'] = dataCollectionSectionForm['vars']['rrChunks'][schemeId]['periods'];
        counter++;
    });

    if (dataCollectionSectionForm['vars']['compare'] == true &&
        Object.keys(dataCollectionSectionForm['vars']['rrChunks']).length !== dataCollectionSectionForm['vars']['rrChartOptions']['series'].length
    ) {
        return;
    }

    dataCollectionSectionForm['vars']['rrChart'].setOption({series: []}, {replaceMerge: ['series']});

    dataCollectionSectionForm['vars']['rrChart'].setOption(dataCollectionSectionForm['vars']['rrChartOptions']);

    $('#rr-chart').attr('hidden', false);

    dataCollectionSectionForm['funcs']['popluateStatisticsTable']();
}

dataCollectionSectionForm['funcs']['popluateStatisticsTable'] = function() {
    var statsHtml = '';

    $.each(dataCollectionSectionForm['vars']['rrChunks'], function(schemeId, rrData) {
        statsHtml += '<tr>';

        if (dataCollectionSectionForm['vars']['compare'] == true) {
            statsHtml += '<td>' + dataCollectionSectionForm['vars']['compareSchemes'][schemeId]['name'] + '</td>';
        }

        if (rrData['rrStatistics']) {
            if (rrData['rrStatistics']['average']) {
                statsHtml += '<td>' + rrData['rrStatistics']['average'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrStatistics']['median']) {
                statsHtml += '<td>' + rrData['rrStatistics']['median'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrStatistics']['max']) {
                statsHtml += '<td>' + rrData['rrStatistics']['max'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrStatistics']['min']) {
                statsHtml += '<td>' + rrData['rrStatistics']['min'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
        }
        if (rrData['rrDistributions']) {
            if (rrData['rrDistributions']['negative']) {
                statsHtml += '<td>' + rrData['rrDistributions']['negative'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrDistributions']['0-8']) {
                statsHtml += '<td>' + rrData['rrDistributions']['0-8'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrDistributions']['8-10']) {
                statsHtml += '<td>' + rrData['rrDistributions']['8-10'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrDistributions']['10-12']) {
                statsHtml += '<td>' + rrData['rrDistributions']['10-12'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrDistributions']['12-15']) {
                statsHtml += '<td>' + rrData['rrDistributions']['12-15'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrDistributions']['15-20']) {
                statsHtml += '<td>' + rrData['rrDistributions']['15-20'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
            if (rrData['rrDistributions']['20+']) {
                statsHtml += '<td>' + rrData['rrDistributions']['20+'] + '</td>';
            } else {
                statsHtml += '<td>0</td>';
            }
        }
        statsHtml += '</tr>';
    });

    $('#{{componentId}}-{{sectionId}}-statistics-table tbody').html(statsHtml);
}

dataCollectionSectionForm['funcs']['updateSchemeCustomNavs'] = function() {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['scheme_id'] = dataCollectionSectionForm['vars']['scheme']['id'];
    postData['custom_navs_percent'] = $('#{{componentId}}-{{sectionId}}-custom').val();

    $.post('{{links.url("mf/schemes/updateSchemeCustomNavs")}}', postData, function(response) {
        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }

        if (response.responseCode === 0) {
            if (response.responseData.scheme && response.responseData.scheme.navs && response.responseData.scheme.navs.navs) {
                dataCollectionSectionForm['vars']['schemeNavs'] = response.responseData.scheme.navs.navs;
                dataCollectionSectionForm['funcs']['processSchemeData']();
                if ($('#{{componentId}}-{{sectionId}}-custom').val() !== '') {
                    $('#{{componentId}}-{{sectionId}}-custom')
                        .val(
                            $('#{{componentId}}-{{sectionId}}-custom').val() + ',' + dataCollectionSectionForm['vars']['schemeNavsPercent'].toString()
                        );
                } else {
                    $('#{{componentId}}-{{sectionId}}-custom').val(dataCollectionSectionForm['vars']['schemeNavsPercent'].toString());
                }
            } else {
                paginatedPNotify('error', {
                    text : 'Scheme data not found!'
                });
            }
        } else {
            paginatedPNotify('error', {
                text : response.responseMessage
            });
        }
    }, 'json');
}

dataCollectionSectionForm['funcs']['generateCustomNav'] = function() {
    var postData = { };
    postData[$('#security-token').attr('name')] = $('#security-token').val();
    postData['source'] = dataCollectionSectionForm['vars']['source'];
    if (Object.keys(dataCollectionSectionForm['vars']['custom']).length === 0) {
        postData['startValue'] = 0;
    } else {
        postData['startValue'] = dataCollectionSectionForm['vars']['custom'][dataCollectionSectionForm['vars']['custom'].length - 1];
    }
    if (dataCollectionSectionForm['vars']['source'] === 'fixed_linear' ||
        dataCollectionSectionForm['vars']['source'] === 'fixed_random'
    ) {
        postData['numberOfDays'] = $('#{{componentId}}-{{sectionId}}-' + postData['source'] +  '_number_of_days').val();
        postData['totalPercent'] = $('#{{componentId}}-{{sectionId}}-' + postData['source'] +  '_total_percent').val();
    } else if (dataCollectionSectionForm['vars']['source'] === 'current_navs') {
        postData['scheme_id'] = dataCollectionSectionForm['vars']['scheme']['id'];
    } else if (dataCollectionSectionForm['vars']['source'] === 'patterns') {
        postData['pattern_id'] = dataCollectionSectionForm['vars']['pattern_id'];
    }

    $.post('{{links.url("mf/schemes/generateCustomNav")}}', postData, function(response) {
        if (response.responseCode == 0 && response.responseData.pattern) {
            if ($('#{{componentId}}-{{sectionId}}-custom').val() !== '') {
                $('#{{componentId}}-{{sectionId}}-custom')
                    .val(
                        $('#{{componentId}}-{{sectionId}}-custom').val() + ',' + response.responseData.pattern.toString()
                    );
            } else {
                $('#{{componentId}}-{{sectionId}}-custom').val(response.responseData.pattern.toString());
            }
        } else {
            paginatedPNotify('error', response.responseMessage);
        }

        if (response.tokenKey && response.token) {
            $("#security-token").attr("name", response.tokenKey);
            $("#security-token").val(response.token);
        }
    }, 'json');
}
</script>
<!-- htmlmin:ignore -->